- [1. Setup](#1-setup)
  - [1.1. Database setup](#11-database-setup)
    - [1.1.1. Run docker SQL Server](#111-run-docker-sql-server)
    - [1.1.2. Prepare DB](#112-prepare-db)
    - [1.1.3. Initialize empty DB schema](#113-initialize-empty-db-schema)
      - [1.1.3.1. Initialize DB schema using SQL scripts](#1131-initialize-db-schema-using-sql-scripts)
      - [1.1.3.2. Initialize DB schema by executing SettleChat.exe with argument](#1132-initialize-db-schema-by-executing-settlechatexe-with-argument)
  - [1.2. How to connect to DB:](#12-how-to-connect-to-db)
  - [1.3. Logging setup](#13-logging-setup)
    - [1.3.1. Run docker SEQ server](#131-run-docker-seq-server)
    - [1.3.2. Sentry](#132-sentry)
  - [1.4. Configuration](#14-configuration)
    - [1.4.1. Create Google ClientId and ClientSecret:](#141-create-google-clientid-and-clientsecret)
    - [1.4.2. Create configuration files:](#142-create-configuration-files)
- [2. Development](#2-development)
  - [2.1. Visual Studio](#21-visual-studio)
  - [2.2. Database migrations:](#22-database-migrations)
- [3. Publish](#3-publish)
- [4. Run for Production](#4-run-for-production)
- [5. Deployment](#5-deployment)
  - [5.1. Migrate DB schema to latest](#51-migrate-db-schema-to-latest)
- [6. Postman](#6-postman)
- [7. Bundle analysis](#7-bundle-analysis)
- [8. Troubleshooting](#8-troubleshooting)
  - [8.1. Cannot login with user SettleAdmin after DB restore](#81-cannot-login-with-user-settleadmin-after-db-restore)


# 1. Setup
## 1.1. Database setup
### 1.1.1. Run docker SQL Server
Create folder `C:\SettleChat\SqlVolume` where subfolders for container volumes will be mapped

``` cmd
.\Installation\01_Database\01_RunDockerSqlServer.cmd
```

>[Extra] Command for removal of docker SQL Server (in case needed to restart with clean DB)**
>``` cmd
>.\Installation\01_Database\__01_RemoveDockerSqlServer.cmd
>```

### 1.1.2. Prepare DB
This will create:
1. login
2. database
3. user

``` cmd
.\Installation\01_Database\02_PrepareDB.cmd
```

### 1.1.3. Initialize empty DB schema
There are 2 options:
1. Using SQL scripts (using source codes)
2. Executing SettleChat.exe with argument (no source codes needed - usefull for migrations in CI/CD)

#### 1.1.3.1. Initialize DB schema using SQL scripts
Make sure latests schema is generated by executing 
``` cmd
.\Development\GenerateSchemaCreateScript.cmd
```
Then execute creation of schema in DB
``` cmd
.\Installation\01_Database\03_CreateDBSchema.cmd
```

#### 1.1.3.2. Initialize DB schema by executing SettleChat.exe with argument
Take a look how to [migrate DB schema to latest](#migrate-DB-schema-to-latest) at [Deployment](#Deployment) section

## 1.2. How to connect to DB:
>**Host**: *localhost,1433*\
**Login**: *SettleAdmin*\
**Password**: *mUtLw5i4YL/oo/S4JnzNPP0ImZ7K5fx5grTC+dXMjZA=*

## 1.3. Logging setup
### 1.3.1. Run docker SEQ server
Create empty folder for persisting Seq data: *C:\SettleChatSecrets\seq*

``` cmd
.\Installation\02_Logging\01_RunDockerSeq.cmd
```

Go to http://127.0.0.1:5340 and enable authentication under *Settings -> USERS*

### 1.3.2. Sentry
Update Sentry DSN in `.\SettleChat\ClientApp\src\index.tsx`

---

## 1.4. Configuration

### 1.4.1. Create Google ClientId and ClientSecret:
- Create `OAuth 2.0 Client IDs` (https://console.developers.google.com/apis/credentials)
- Enter following URIs under `Authorized redirect URIs` section:
  - *https​://localhost:44328/signin-google*
  - *https​://localhost:44328/authentication/login-callback*
  
### 1.4.2. Create configuration files:
- `C:\SettleChatSecrets\appsettings.json` (**optional**, can contain common secret settings)
- `C:\SettleChatSecrets\appsettings.Development.json` (**optional**, can contain secret settings for development)
- `C:\SettleChatSecrets\appsettings.Production.json` (**optional**, can contain secret settings for production)

Content of `appsettings.Production.json`:
```json
{
  "IdentityServer": {    
    "Key": {
      "Type": "File",
      "FilePath": "C:\\SettleChatSecrets\\MyIdentityServerCert.pfx",
      "Password": "<password used by .pfx>"
    }
  },
  "GoogleOAuth:ClientId":"<client id from google developer console>",
  "GoogleOAuth:ClientSecret":"<client secret from google developer console>"
}
```
>Note: Certificate configuration for IdentityServer is read by `AddSigningCredentials()` inside of `AddApiAuthorization()`

`C:\SettleChatSecrets\MyIdentityServerCert.pfx` (optional - needed for IdentityServer for production - google how to create certificate for .NET Core app, e.g. https://benjii.me/2017/06/creating-self-signed-certificate-identity-server-azure/)




# 2. Development
## 2.1. Visual Studio
Make sure Typescript 4.2 for Visual Studio is installed: https://marketplace.visualstudio.com/items?itemName=TypeScriptTeam.typescript-42
>Typescript 4.2 is referenced in .csproj in order to make tsconfig.json setting "--jsx":"react-jsx" (which is forced by Create-React-App `npm run start` command) work in Visual Studio
## 2.2. Database migrations:
1. when model changed, create migration by executing in VS Package Manager Console 
```
Add-Migration <MigrationName>
```
2. propagate changes to DB>
    1. in VS *Package Manager Console* select *Default project* SettleChat.Migrations
    2. 
       ```
       Update-Database
       ```



# 3. Publish
Publish using VisualStudio publish profile called `FolderProfile`

# 4. Run for Production 
(when published using `FolderProfile` Visual Studio publish profile)
``` cmd
.\SettleChat\bin\Release\netcoreapp3.1\publish\RunProduction.bat
```

# 5. Deployment

## 5.1. Migrate DB schema to latest
Make sure latest SettleChat.exe is built

>[Extra] It's possible to check if there are pending DB migrations to be applied by running 
>``` cmd
>.\Deployment\DBMigrationPendingCheck.cmd
>```

Then execute 
``` cmd
.\Deployment\DBMigration.cmd
```


# 6. Postman
Exported Postman configuration is here: `.\SettleChat local development.postman_collection.json`

# 7. Bundle analysis
1. Build

        npm run build
        
2. Analyze 
        
        npm run analyze

# 8. Troubleshooting
## 8.1. Cannot login with user SettleAdmin after DB restore
Execute on SQL Server
``` sql
USE [SettleChat] 
ALTER USER [SettleAdmin] WITH LOGIN = SettleAdmin
GO
```